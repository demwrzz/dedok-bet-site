<!-- Supabase Backend Entegrasyonu -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// SUPABASE AYARLARI
const SUPABASE_URL = 'https://vkuhfhjibegquqatxmyt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdWhmaGppYmVncXVxYXR4bXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDEwNzMsImV4cCI6MjA3OTkxNzA3M30.1Ir2Hy43qw6ey59gGytr8Jo3OKUC9y5pt8Jwj76PPPc';

// Supabase baÄŸlantÄ±sÄ±
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// BaÄŸlantÄ± durumu kontrolÃ¼
let isConnected = false;

// Supabase Backend FonksiyonlarÄ±
class SupabaseBackend {
  // KullanÄ±cÄ± kayÄ±t
  static async registerUser(username) {
    const { data, error } = await supabase
      .from('users')
      .insert([{ username, inventory: '[]' }])
      .select();
    
    return { success: !error, user: data ? data[0] : null };
  }

  // Chat mesajÄ± gÃ¶nder
  static async sendMessage(sender, message) {
    const { error } = await supabase
      .from('chat_messages')
      .insert([{ sender, message }]);
    
    return { success: !error };
  }

  // Yeni maÃ§ oluÅŸtur
  static async createMatch(matchData) {
    // Items'i JSON formatÄ±na Ã§evir
    const matchToInsert = {
      ...matchData,
      items: JSON.stringify(matchData.items),
      player2_items: matchData.player2_items ? JSON.stringify(matchData.player2_items) : null
    };
    
    const { data, error } = await supabase
      .from('matchlist')
      .insert([matchToInsert])
      .select();
    
    return { success: !error, match: data ? data[0] : null };
  }

  // TÃ¼m maÃ§larÄ± getir
  static async getMatches() {
    const { data, error } = await supabase
      .from('matchlist')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('MaÃ§lar yÃ¼klenirken hata:', error);
      return [];
    }
    
    // JSON verilerini parse et
    return data.map(match => ({
      ...match,
      items: match.items ? JSON.parse(match.items) : [],
      player2_items: match.player2_items ? JSON.parse(match.player2_items) : null
    }));
  }

  // MaÃ§a katÄ±l
  static async joinMatch(matchId, playerData) {
    const { error } = await supabase
      .from('matchlist')
      .update({ 
        player2: playerData.username,
        player2_items: JSON.stringify(playerData.items),
        status: 'active'
      })
      .eq('id', matchId);
    
    return { success: !error };
  }

  // TÃ¼m chat mesajlarÄ±nÄ± getir
  static async getChatMessages() {
    const { data, error } = await supabase
      .from('chat_messages')
      .select('*')
      .order('created_at', { ascending: true })
      .limit(50);
    
    return error ? [] : data;
  }

  // BaÄŸlantÄ± durumunu kontrol et
  static async checkConnection() {
    try {
      const { data, error } = await supabase
        .from('chat_messages')
        .select('count')
        .limit(1);
      
      return { success: !error, connected: !error };
    } catch (err) {
      return { success: false, connected: false };
    }
  }
}

// Eski BackendAPI yerine bunu kullan
const BackendAPI = SupabaseBackend;
</script>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dedok Bet - CoinFlip</title>
    <style>
        /* Ã–nceki CSS kodlarÄ± aynen kalacak */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* ... DiÄŸer CSS stilleri aynen ... */
        
        /* BaÄŸlantÄ± Durumu */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            background: #4CAF50;
            color: white;
        }
        
        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }
        
        .connection-status.connecting {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <!-- BaÄŸlantÄ± Durumu -->
    <div class="connection-status disconnected" id="connectionStatus">
        <span id="connectionIcon">ğŸ”´</span> Ã‡evrimdÄ±ÅŸÄ±
    </div>

    <!-- GiriÅŸ SayfasÄ± -->
    <div class="container" id="loginContainer" style="max-width: 450px; margin: 50px auto;">
        <!-- ... GiriÅŸ formu iÃ§eriÄŸi aynen ... -->
    </div>

    <!-- Ana Uygulama -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- ... Ana uygulama iÃ§eriÄŸi aynen ... -->
    </div>

    <!-- ... Modal'lar aynen ... -->

    <script>
        // DOM Elementleri
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionIcon = document.getElementById('connectionIcon');
        // ... DiÄŸer DOM elementleri aynen ...

        // DeÄŸiÅŸkenler
        let currentUser = null;
        let verificationCode = '';
        let activeMatches = [];
        let userInventory = [];
        let selectedItemsForMatch = [];
        let selectedSideForMatch = null;
        let selectedItemsForTip = [];
        let isConnected = false;
        let connectionCheckInterval;

        // BaÄŸlantÄ± durumunu gÃ¼ncelle
        function updateConnectionStatus(connected, message = '') {
            isConnected = connected;
            
            if (connected) {
                connectionStatus.textContent = 'ğŸŸ¢ Ã‡evrimiÃ§i';
                connectionStatus.className = 'connection-status connected';
                connectionIcon.textContent = 'ğŸŸ¢';
            } else {
                connectionStatus.textContent = 'ğŸ”´ Ã‡evrimdÄ±ÅŸÄ±';
                connectionStatus.className = 'connection-status disconnected';
                connectionIcon.textContent = 'ğŸ”´';
            }
            
            if (message) {
                console.log('BaÄŸlantÄ± durumu:', message);
            }
        }

        // BaÄŸlantÄ± kontrolÃ¼
        async function checkConnection() {
            try {
                const result = await BackendAPI.checkConnection();
                if (result.connected && !isConnected) {
                    updateConnectionStatus(true, 'Supabase baÄŸlantÄ±sÄ± kuruldu');
                } else if (!result.connected && isConnected) {
                    updateConnectionStatus(false, 'Supabase baÄŸlantÄ±sÄ± kesildi');
                }
                return result.connected;
            } catch (error) {
                updateConnectionStatus(false, 'BaÄŸlantÄ± kontrolÃ¼ baÅŸarÄ±sÄ±z: ' + error.message);
                return false;
            }
        }

        // SÃ¼rekli baÄŸlantÄ± kontrolÃ¼
        function startConnectionMonitoring() {
            // Ä°lk kontrol
            checkConnection();
            
            // Her 30 saniyede bir kontrol et
            connectionCheckInterval = setInterval(checkConnection, 30000);
        }

        // Real-time dinleyicileri baÅŸlat
        function initializeRealtimeListeners() {
            console.log('Real-time dinleyiciler baÅŸlatÄ±lÄ±yor...');
            
            // BaÄŸlantÄ± durumu dinleyicisi
            supabase
                .channel('system')
                .on('system', { event: 'connected' }, () => {
                    console.log('Real-time baÄŸlantÄ±sÄ± kuruldu');
                    updateConnectionStatus(true, 'Real-time baÄŸlantÄ±sÄ± aktif');
                })
                .on('system', { event: 'disconnected' }, () => {
                    console.log('Real-time baÄŸlantÄ±sÄ± kesildi');
                    updateConnectionStatus(false, 'Real-time baÄŸlantÄ±sÄ± kesildi');
                })
                .subscribe((status) => {
                    console.log('Real-time subscription status:', status);
                    if (status === 'SUBSCRIBED') {
                        updateConnectionStatus(true, 'Real-time kanallarÄ±na abone olundu');
                    }
                });

            // Chat mesajlarÄ± iÃ§in real-time dinleyici
            const chatChannel = supabase
                .channel('public:chat_messages')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'chat_messages' 
                    }, 
                    (payload) => {
                        console.log('Yeni mesaj geldi:', payload);
                        addChatMessage(payload.new.sender, payload.new.message);
                        // Mesaj geldiÄŸinde baÄŸlantÄ±nÄ±n aktif olduÄŸunu varsay
                        updateConnectionStatus(true, 'Yeni mesaj alÄ±ndÄ±');
                    }
                )
                .subscribe((status) => {
                    console.log('Chat channel status:', status);
                });

            // MaÃ§lar iÃ§in real-time dinleyici
            const matchesChannel = supabase
                .channel('public:matchlist')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'matchlist' 
                    }, 
                    (payload) => {
                        console.log('MaÃ§ deÄŸiÅŸikliÄŸi:', payload);
                        handleMatchChange(payload);
                        // MaÃ§ deÄŸiÅŸikliÄŸi geldiÄŸinde baÄŸlantÄ±nÄ±n aktif olduÄŸunu varsay
                        updateConnectionStatus(true, 'MaÃ§ gÃ¼ncellemesi alÄ±ndÄ±');
                    }
                )
                .subscribe((status) => {
                    console.log('Matches channel status:', status);
                });

            return { chatChannel, matchesChannel };
        }

        // MaÃ§ deÄŸiÅŸikliklerini iÅŸle
        function handleMatchChange(payload) {
            if (payload.eventType === 'INSERT') {
                // Yeni maÃ§ eklendi
                const newMatch = {
                    ...payload.new,
                    items: payload.new.items ? JSON.parse(payload.new.items) : [],
                    player2_items: payload.new.player2_items ? JSON.parse(payload.new.player2_items) : null
                };
                
                if (!activeMatches.some(m => m.id === newMatch.id)) {
                    activeMatches.push(newMatch);
                    updateMatchesDisplay();
                    addChatMessage("Sistem", `${newMatch.creator} yeni bir CoinFlip maÃ§Ä± oluÅŸturdu!`);
                }
            } else if (payload.eventType === 'UPDATE') {
                // MaÃ§ gÃ¼ncellendi
                const updatedMatch = {
                    ...payload.new,
                    items: payload.new.items ? JSON.parse(payload.new.items) : [],
                    player2_items: payload.new.player2_items ? JSON.parse(payload.new.player2_items) : null
                };
                
                const index = activeMatches.findIndex(m => m.id === updatedMatch.id);
                if (index !== -1) {
                    activeMatches[index] = updatedMatch;
                    updateMatchesDisplay();
                    
                    if (updatedMatch.player2 && !payload.old.player2) {
                        addChatMessage("Sistem", `${updatedMatch.player2} ${updatedMatch.creator}'Ä±n maÃ§Ä±na katÄ±ldÄ±!`);
                    }
                }
            } else if (payload.eventType === 'DELETE') {
                // MaÃ§ silindi
                activeMatches = activeMatches.filter(m => m.id !== payload.old.id);
                updateMatchesDisplay();
            }
        }

        // Chat mesajÄ± ekle
        function addChatMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            messageElement.innerHTML = `<span class="sender">${sender}:</span> ${message}`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Sayfa yÃ¼klendiÄŸinde oturum kontrolÃ¼
        document.addEventListener('DOMContentLoaded', async function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                userInventory = JSON.parse(localStorage.getItem('userInventory')) || [];
                
                // BaÄŸlantÄ± kontrolÃ¼nÃ¼ baÅŸlat
                startConnectionMonitoring();
                
                await showMainApp();
            } else {
                // KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ olsa bile baÄŸlantÄ±yÄ± kontrol et
                startConnectionMonitoring();
            }
        });

        // Ana uygulamayÄ± gÃ¶ster
        async function showMainApp() {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            coinflipContainer.style.display = 'flex';
            coinflipUsername.textContent = currentUser;
            
            try {
                // BaÄŸlantÄ± durumunu kontrol et
                const connected = await checkConnection();
                if (!connected) {
                    console.warn('BaÅŸlangÄ±Ã§ta baÄŸlantÄ± kurulamadÄ±, yeniden deneyebilir');
                }

                // Mevcut maÃ§larÄ± yÃ¼kle
                const matches = await BackendAPI.getMatches();
                activeMatches = matches;
                updateMatchesDisplay();
                
                // Mevcut chat mesajlarÄ±nÄ± yÃ¼kle
                const chatMessagesData = await BackendAPI.getChatMessages();
                chatMessages.innerHTML = '';
                chatMessagesData.forEach(msg => {
                    addChatMessage(msg.sender, msg.message);
                });
                
                // Real-time dinleyicileri baÅŸlat
                initializeRealtimeListeners();
                
                console.log('Uygulama baÅŸlatÄ±ldÄ±:', { 
                    currentUser, 
                    matchesCount: activeMatches.length,
                    connected: isConnected 
                });
            } catch (error) {
                console.error('Uygulama baÅŸlatÄ±lÄ±rken hata:', error);
                // Hata olsa bile uygulamayÄ± gÃ¶ster
                updateConnectionStatus(false, 'BaÅŸlangÄ±Ã§ hatasÄ±: ' + error.message);
            }
        }

        // Ã‡Ä±kÄ±ÅŸ butonu tÄ±klama olayÄ±
        logoutBtn.addEventListener('click', function() {
            // LocalStorage'Ä± temizle
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userInventory');
            
            // BaÄŸlantÄ± kontrolÃ¼nÃ¼ durdur
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
            }
            
            appContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            showStep(1);
            // Formu sÄ±fÄ±rla
            usernameInput.value = '';
            termsCheckbox.checked = false;
            activeMatches = [];
            currentUser = null;
            userInventory = [];
            updateTotalValue();
            
            // BaÄŸlantÄ± durumunu gÃ¼ncelle
            updateConnectionStatus(false, 'KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸ yaptÄ±');
        });

        // Sayfa kapatÄ±ldÄ±ÄŸÄ±nda temizlik
        window.addEventListener('beforeunload', function() {
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
            }
            
            if (currentUser) {
                localStorage.setItem('currentUser', currentUser);
                localStorage.setItem('userInventory', JSON.stringify(userInventory));
            }
        });

        // Manuel baÄŸlantÄ± testi butonu (isteÄŸe baÄŸlÄ± - debug iÃ§in)
        function addConnectionTestButton() {
            const testBtn = document.createElement('button');
            testBtn.textContent = 'BaÄŸlantÄ±yÄ± Test Et';
            testBtn.style.position = 'fixed';
            testBtn.style.bottom = '10px';
            testBtn.style.right = '10px';
            testBtn.style.zIndex = '1000';
            testBtn.style.padding = '5px 10px';
            testBtn.style.fontSize = '12px';
            testBtn.style.background = '#2196F3';
            testBtn.style.color = 'white';
            testBtn.style.border = 'none';
            testBtn.style.borderRadius = '5px';
            testBtn.style.cursor = 'pointer';
            
            testBtn.addEventListener('click', async function() {
                connectionStatus.textContent = 'ğŸŸ¡ Kontrol ediliyor...';
                connectionStatus.className = 'connection-status connecting';
                
                const connected = await checkConnection();
                if (connected) {
                    alert('âœ… BaÄŸlantÄ± baÅŸarÄ±lÄ±!');
                } else {
                    alert('âŒ BaÄŸlantÄ± baÅŸarÄ±sÄ±z!');
                }
            });
            
            document.body.appendChild(testBtn);
        }

        // Debug iÃ§in baÄŸlantÄ± test butonunu ekle
        addConnectionTestButton();

        // ... DiÄŸer fonksiyonlar aynen kalacak ...
    </script>
</body>
</html>
